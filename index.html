<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Catalog New Instance in FOLIO</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 600px;
      margin: auto;
      padding: 20px;
      text-align: center;
    }
    input, button {
      width: 100%;
      padding: 10px;
      margin-top: 10px;
    }
    label {
      display: block;
      text-align: left;
      margin-top: 15px;
    }
    .hidden { display: none; }
  </style>
</head>
<body>
  <h1>Catalog New Instance in FOLIO</h1>
  <div id="loginStatus">‚è≥ Logging in...</div>

  <form id="catalogForm" class="hidden">
    <label>Title:
      <input type="text" id="title" required />
    </label>
    <label>Contributor:
      <input type="text" id="contributor" />
    </label>
    <label>ISBN:
      <input type="text" id="isbn" />
    </label>
    <button type="submit">üì• Save Record</button>
  </form>

  <div id="responseBox" style="margin-top: 20px;"></div>

  <script>
    let okapiToken = "";
    const proxyUrl = "https://corsproxy.io/?";
    const loginUrl = "https://folio-snapshot.dev.folio.org/authn/login";
    const instanceUrl = "https://folio-snapshot.dev.folio.org/inventory/instances";

    async function login() {
      try {
        const res = await fetch(proxyUrl + encodeURIComponent(loginUrl), {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "X-Okapi-Tenant": "diku"
          },
          body: JSON.stringify({ username: "diku_admin", password: "admin" })
        });

        okapiToken = res.headers.get("x-okapi-token");
        if (res.ok && okapiToken) {
          document.getElementById("loginStatus").textContent = "‚úÖ Logged in";
          document.getElementById("catalogForm").classList.remove("hidden");
        } else {
          document.getElementById("loginStatus").innerHTML = `‚ùå Login failed.<br>Status: ${res.status}`;
        }
      } catch (err) {
        document.getElementById("loginStatus").innerHTML = `‚ùå JavaScript Error: ${err}`;
      }
    }

    document.getElementById("catalogForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const title = document.getElementById("title").value;
      const contributor = document.getElementById("contributor").value;
      const isbn = document.getElementById("isbn").value;

      const instance = {
        title,
        identifiers: isbn ? [{
          identifierTypeId: "8261054f-be78-422d-bd51-4ed9f33c3422",
          value: isbn
        }] : [],
        contributors: contributor ? [{
          name: contributor,
          contributorNameTypeId: "2b94c631-fca9-4892-a730-03ee529ffe27"
        }] : [],
        instanceTypeId: "6312d172-f0cf-40f6-b27d-9fa8feaf332f"
      };

      const responseBox = document.getElementById("responseBox");
      responseBox.innerHTML = "‚è≥ Saving...";

      try {
        const response = await fetch(proxyUrl + encodeURIComponent(instanceUrl), {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "X-Okapi-Tenant": "diku",
            "X-Okapi-Token": okapiToken
          },
          body: JSON.stringify(instance)
        });

        if (response.ok) {
          const result = await response.json();
          responseBox.innerHTML = `‚úÖ Saved!<br>Instance ID: <code>${result.id}</code>`;
        } else {
          const error = await response.text();
          responseBox.innerHTML = `<span style='color:red'>‚ùå Error: ${error}</span>`;
        }
      } catch (err) {
        responseBox.innerHTML = `<span style='color:red'>‚ùå JavaScript Error: ${err}</span>`;
      }
    });

    login();
  </script>
</body>
</html>
